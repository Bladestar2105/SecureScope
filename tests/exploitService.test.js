const ExploitService = require('../services/exploitService');

jest.mock('../config/database', () => ({
    getDatabase: jest.fn()
}));

jest.mock('../services/logger', () => ({
    info: jest.fn(),
    warn: jest.fn(),
    error: jest.fn(),
    audit: jest.fn()
}));

describe('ExploitService', () => {
    describe('compareVersions', () => {
        test('should correctly compare basic versions', () => {
            expect(ExploitService.compareVersions('1.0', '2.0')).toBe(-1);
            expect(ExploitService.compareVersions('2.1', '2.0')).toBe(1);
            expect(ExploitService.compareVersions('1.1', '1.1')).toBe(0);
        });

        test('should handle different version lengths', () => {
            expect(ExploitService.compareVersions('1.2', '1.2.3')).toBe(-1);
            expect(ExploitService.compareVersions('1.2.3', '1.2')).toBe(1);
            expect(ExploitService.compareVersions('1.2.0', '1.2')).toBe(0);
        });

        test('should handle common suffixes by treating them as separators', () => {
            // 1.2p1 becomes 1.2.1, which is > 1.2
            expect(ExploitService.compareVersions('1.2p1', '1.2')).toBe(1);
            // 8.2-beta becomes 8.2, which is == 8.2
            expect(ExploitService.compareVersions('8.2-beta', '8.2')).toBe(0);
            // 2.4.51-ubuntu becomes 2.4.51, which is == 2.4.51
            expect(ExploitService.compareVersions('2.4.51-ubuntu', '2.4.51')).toBe(0);
        });

        test('should handle null or undefined inputs', () => {
            expect(ExploitService.compareVersions(null, '1.0')).toBe(0);
            expect(ExploitService.compareVersions('1.0', undefined)).toBe(0);
            expect(ExploitService.compareVersions(null, undefined)).toBe(0);
        });
    });

    describe('isVersionVulnerable', () => {
        test('should return false if detectedVersion is missing', () => {
            expect(ExploitService.isVersionVulnerable(null, '1.0', '2.0')).toBe(false);
            expect(ExploitService.isVersionVulnerable('', '1.0', '2.0')).toBe(false);
        });

        test('should return false if both constraints are missing', () => {
            expect(ExploitService.isVersionVulnerable('1.0', null, null)).toBe(false);
        });

        test('should return true for exact matches', () => {
            expect(ExploitService.isVersionVulnerable('1.2.3', '1.2.3', '2.0.0')).toBe(true);
            expect(ExploitService.isVersionVulnerable('2.0.0', '1.2.3', '2.0.0')).toBe(true);
        });

        test('should return true for substring matches with min', () => {
            // detected "2.4.51" contains min "2.4"
            expect(ExploitService.isVersionVulnerable('2.4.51', '2.4', null)).toBe(true);
            // min "2.4.51" contains detected "2.4"
            expect(ExploitService.isVersionVulnerable('2.4', '2.4.51', null)).toBe(true);
        });

        test('should correctly check range matches', () => {
            expect(ExploitService.isVersionVulnerable('1.5', '1.0', '2.0')).toBe(true);
            expect(ExploitService.isVersionVulnerable('0.9', '1.0', '2.0')).toBe(false);
            expect(ExploitService.isVersionVulnerable('2.1', '1.0', '2.0')).toBe(false);
        });

        test('should handle only versionMin', () => {
            expect(ExploitService.isVersionVulnerable('1.5', '1.0', null)).toBe(true);
            expect(ExploitService.isVersionVulnerable('1.0', '1.0', null)).toBe(true);
            expect(ExploitService.isVersionVulnerable('0.5', '1.0', null)).toBe(false);
        });

        test('should handle only versionMax', () => {
            expect(ExploitService.isVersionVulnerable('1.5', null, '2.0')).toBe(true);
            expect(ExploitService.isVersionVulnerable('2.0', null, '2.0')).toBe(true);
            expect(ExploitService.isVersionVulnerable('2.5', null, '2.0')).toBe(false);
        });

        test('should handle complex version strings in range check', () => {
            expect(ExploitService.isVersionVulnerable('2.4.51', '2.4.40', '2.4.60')).toBe(true);
            // 8.2p1 is correctly identified as being between 8.0 and 8.3
            expect(ExploitService.isVersionVulnerable('8.2p1', '8.0', '8.3')).toBe(true);
        });
    });
});
