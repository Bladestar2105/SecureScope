const ExploitService = require('../services/exploitService');
const { getDatabase } = require('../config/database');

// Mock database
jest.mock('../config/database', () => ({
    getDatabase: jest.fn()
}));

// Mock logger
jest.mock('../services/logger', () => ({
    info: jest.fn(),
    error: jest.fn(),
    warn: jest.fn()
}));

describe('Exploit Fix Verification', () => {
    let mockDb;
    let mockPrepare;
    let mockAll;

    beforeEach(() => {
        mockAll = jest.fn();
        mockPrepare = jest.fn().mockReturnValue({ all: mockAll, run: jest.fn() });
        mockDb = {
            prepare: mockPrepare,
            transaction: jest.fn((cb) => cb)
        };
        getDatabase.mockReturnValue(mockDb);
    });

    test('ExploitService.getAliases returns correct aliases for smb/microsoft-ds', () => {
        const aliases1 = ExploitService.getAliases('microsoft-ds');
        expect(aliases1).toContain('smb');
        expect(aliases1).toContain('netbios-ssn');
        expect(aliases1).toContain('microsoft-ds');

        const aliases2 = ExploitService.getAliases('smb');
        expect(aliases2).toContain('microsoft-ds');
    });

    test('ExploitService.matchScanResults uses aliases in SQL query', () => {
        // Mock scan results
        const scanId = 1;
        mockPrepare.mockImplementation((sql) => {
            if (sql.includes('SELECT sr.*')) {
                return {
                    all: jest.fn().mockReturnValue([{
                        id: 101,
                        scan_id: scanId,
                        ip_address: '192.168.1.10',
                        port: 445,
                        service: 'microsoft-ds',
                        state: 'open',
                        detected_service: 'microsoft-ds', // Step 2 triggers here
                        detected_version: null,
                        detected_os: 'Windows XP'
                    }])
                };
            }
            if (sql.includes('INSERT OR IGNORE')) {
                return { run: jest.fn() };
            }
            // Exploit match query
            if (sql.includes('FROM exploits WHERE port = ?')) {
                return { all: jest.fn().mockReturnValue([]) }; // Step 1: Port match
            }
            if (sql.includes('LOWER(service_name) IN')) {
                 return { all: jest.fn().mockReturnValue([{
                     id: 500,
                     title: 'MS06-040 NetAPI',
                     service_name: 'smb', // Matches alias!
                     port: 445,
                     cvss_score: 9.0,
                     severity: 'critical'
                 }]) };
            }
            return { all: jest.fn().mockReturnValue([]) };
        });

        const matches = ExploitService.matchScanResults(scanId);

        expect(matches.length).toBeGreaterThan(0);
        expect(matches[0].exploit.id).toBe(500);
        expect(matches[0].matchReason).toContain('Service-Match');

        // specific check for alias usage
        // We expect `IN (?,?,...)` and the parameters to include 'smb'
        const calls = mockPrepare.mock.calls;
        const aliasQueryCall = calls.find(call => call[0].includes('LOWER(service_name) IN'));
        expect(aliasQueryCall).toBeTruthy();
    });
});
