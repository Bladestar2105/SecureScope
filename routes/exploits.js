const express = require('express');
const router = express.Router();
const { requireAuth } = require('../middleware/auth');
const { requirePermission } = require('../middleware/rbac');
const ExploitService = require('../services/exploitService');
const logger = require('../services/logger');

// Get all exploits
router.get('/', requireAuth, (req, res) => {
    try {
        const filters = {
            severity: req.query.severity,
            service: req.query.service,
            platform: req.query.platform,
            port: req.query.port ? parseInt(req.query.port) : undefined,
            type: req.query.type,
            search: req.query.search,
            page: parseInt(req.query.page) || 1,
            limit: parseInt(req.query.limit) || 50
        };
        const result = ExploitService.getAll(filters);
        res.json(result);
    } catch (err) {
        logger.error('Error fetching exploits:', err);
        res.status(500).json({ error: 'Fehler beim Laden der Exploits' });
    }
});

// Get exploit statistics
router.get('/stats', requireAuth, (req, res) => {
    try {
        const stats = ExploitService.getStats();
        res.json(stats);
    } catch (err) {
        logger.error('Error fetching exploit stats:', err);
        res.status(500).json({ error: 'Fehler beim Laden der Exploit-Statistiken' });
    }
});

// Get exploits for a specific scan
router.get('/scan/:scanId', requireAuth, (req, res) => {
    try {
        const scanId = parseInt(req.params.scanId);
        const exploits = ExploitService.getScanExploits(scanId);
        const summary = ExploitService.getScanExploitSummary(scanId);
        res.json({ exploits, summary });
    } catch (err) {
        logger.error('Error fetching scan exploits:', err);
        res.status(500).json({ error: 'Fehler beim Laden der Scan-Exploits' });
    }
});

// NEW: Get attackable summary for a target IP (which services have matching exploits)
router.get('/attackable/:scanId/:targetIp', requireAuth, (req, res) => {
    try {
        const scanId = parseInt(req.params.scanId);
        const targetIp = req.params.targetIp;
        const summary = ExploitService.getAttackableSummary(scanId, targetIp);
        res.json({ services: summary });
    } catch (err) {
        logger.error('Error fetching attackable summary:', err);
        res.status(500).json({ error: 'Fehler beim Laden der angreifbaren Services' });
    }
});

// NEW: Get matched exploits for a specific target IP
router.get('/matched/:scanId/:targetIp', requireAuth, (req, res) => {
    try {
        const scanId = parseInt(req.params.scanId);
        const targetIp = req.params.targetIp;
        const exploits = ExploitService.getMatchedExploitsForTarget(scanId, targetIp);
        res.json({ exploits });
    } catch (err) {
        logger.error('Error fetching matched exploits:', err);
        res.status(500).json({ error: 'Fehler beim Laden der gematchten Exploits' });
    }
});

// Run exploit matching for a scan
router.post('/match/:scanId', requireAuth, requirePermission('scan:start'), (req, res) => {
    try {
        const scanId = parseInt(req.params.scanId);
        const matches = ExploitService.matchScanResults(scanId);
        res.json({ matches, count: matches.length });
    } catch (err) {
        logger.error('Error matching exploits:', err);
        res.status(500).json({ error: 'Fehler beim Exploit-Matching' });
    }
});

// Get exploit by CVE
router.get('/cve/:cveId', requireAuth, (req, res) => {
    try {
        const exploits = ExploitService.getByCVE(req.params.cveId);
        res.json(exploits);
    } catch (err) {
        logger.error('Error fetching exploit by CVE:', err);
        res.status(500).json({ error: 'Fehler beim Laden des Exploits' });
    }
});

// Create a new exploit entry
router.post('/', requireAuth, requirePermission('vulnerabilities:edit'), (req, res) => {
    try {
        const id = ExploitService.create(req.body);
        res.status(201).json({ id, message: 'Exploit erstellt' });
    } catch (err) {
        logger.error('Error creating exploit:', err);
        res.status(500).json({ error: 'Fehler beim Erstellen des Exploits' });
    }
});

// Delete an exploit
router.delete('/:id', requireAuth, requirePermission('vulnerabilities:edit'), (req, res) => {
    try {
        ExploitService.delete(parseInt(req.params.id));
        res.json({ message: 'Exploit gelöscht' });
    } catch (err) {
        logger.error('Error deleting exploit:', err);
        res.status(500).json({ error: 'Fehler beim Löschen des Exploits' });
    }
});

module.exports = router;